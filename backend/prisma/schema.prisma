generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String      @id @default(cuid())
  username          String      @unique
  email             String      @unique
  passwordHash      String
  preferredLanguage String      @default("es")
  highScore         Int         @default(0)
  gamesPlayed       Int         @default(0)
  wins              Int         @default(0)
  losses            Int         @default(0)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relaciones
  games              GameResult[]
  challengesCreated  Challenge[]            @relation("ChallengeCreator")
  challengeParticipations ChallengeParticipant[]

  @@map("users")
}

model Question {
  id             String   @id @default(cuid())
  category       Category
  questionData   String   // Nombre del país/ciudad o prompt
  options        String[] // Opciones para múltiple choice
  correctAnswer  String
  imageUrl       String?  // URL de bandera o silueta
  latitude       Float?   // Para preguntas de mapa
  longitude      Float?   // Para preguntas de mapa
  continent      String?  // Para generar distractores regionales
  difficulty     Difficulty @default(MEDIUM)
  createdAt      DateTime @default(now())

  @@map("questions")
}

model GameResult {
  id            String   @id @default(cuid())
  userId        String
  score         Int
  correctCount  Int
  totalQuestions Int
  category      Category?
  gameMode      GameMode @default(SINGLE)
  details       Json?    // Desglose de respuestas
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("game_results")
}

model Challenge {
  id              String          @id @default(cuid())
  creatorId       String
  status          ChallengeStatus @default(PENDING)
  categories      Category[]
  maxPlayers      Int
  answerTimeSeconds Int          @default(20)
  questionIds     String[]        // IDs de preguntas para reproducibilidad
  winnerId        String?
  createdAt       DateTime        @default(now())
  expiresAt       DateTime
  completedAt     DateTime?

  creator User @relation("ChallengeCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  participants ChallengeParticipant[]

  @@map("challenges")
}

model ChallengeParticipant {
  id          String   @id @default(cuid())
  challengeId String
  userId      String
  score       Int?
  correctCount Int?
  joinedAt    DateTime @default(now())
  completedAt DateTime?

  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userId])
  @@map("challenge_participants")
}

enum Category {
  MAP
  FLAG
  CAPITAL
  SILHOUETTE
  MIXED
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum GameMode {
  SINGLE
  DUEL
  CHALLENGE
}

enum ChallengeStatus {
  PENDING
  ACCEPTED
  COMPLETED
  EXPIRED
  DECLINED
}
